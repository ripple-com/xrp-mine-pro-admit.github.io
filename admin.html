<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XRP Mine Pro - Admin Plan Configuration</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #eeeeee; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1 { color: #ff9800; border-bottom: 2px solid #03a9f4; padding-bottom: 10px; }
        .plan-section { background-color: #212121; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 5px solid #4CAF50; }
        .plan-section h2 { color: #03a9f4; margin-top: 0; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #bbbbbb; }
        .input-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #333; background-color: #1a1a1a; color: white; border-radius: 5px; }
        .save-btn { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin-right: 10px;}
        .save-btn:hover { background-color: #388e3c; }
        .message { margin-top: 20px; padding: 10px; border-radius: 5px; font-weight: 600; }
        .success { background-color: #388e3c; color: white; }
        .error { background-color: #d32f2f; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>XRP Mine Pro - Admin Plan Configuration</h1>
         <div id="plans-container">
            <div class="error">Loading Admin session...</div>
        </div>

        <button onclick="document.location.href='admin_dashboard.html'" class="save-btn" style="background-color: #ff9800;">Go to Dashboard</button>
        <button id="logout-btn" class="save-btn" style="background-color: #d32f2f;">Logout</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // ⚠️ ඔබගේ Firebase Config එක මෙහි තිබිය යුතුය. (admin_dashboard.html හි ඇති ලෙසම)
        const firebaseConfig = {
            apiKey: "AIzaSyBsTIzaJtaGiAfv4a69o80f0QvKiq6lFj4",
            authDomain: "xrp-mine-pro.firebaseapp.com",
            projectId: "xrp-mine-pro",
            storageBucket: "xrp-mine-pro.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); 

        const planIds = ['free', 'bronze', 'silver', 'gold'];
        
        // ⚠️ ඔබගේ පරිපාලක Email ලිපින මෙහි ඇතුළත් කරන්න. (admin_dashboard.html හි ඇති ලෙසම)
        const ALLOWED_ADMIN_EMAILS = ["admin@xrpminepro.com"]; 
        const ADMIN_LOGIN_PAGE = 'admin_login.html'; 

        // ----------------------------------------------------
        // A. Auth Guard: Admin Check (ප්‍රධාන වෙනස)
        // ----------------------------------------------------
        auth.onAuthStateChanged(async (user) => {
            const plansContainer = document.getElementById('plans-container');
            
            if (!user) {
                // පරිශීලකයෙක් ලොග් වී නැත්නම්, Login පිටුවට යොමු කරන්න.
                window.location.href = ADMIN_LOGIN_PAGE; 
                return;
            }

            // ඔබගේ admin@xrpminepro.com ඊමේල් එක භාවිත කරමින් පරිපාලක පරීක්ෂාව
            if (!ALLOWED_ADMIN_EMAILS.includes(user.email)) {
                // ලොග් වී සිටියද Admin නොවේ නම්, ප්‍රවේශය ප්‍රතික්ෂේප කරන්න.
                plansContainer.innerHTML = `<div class="error">Access Denied: Not an authorized admin.</div>`;
                await auth.signOut();
                window.location.href = ADMIN_LOGIN_PAGE;
                return;
            }

            // Admin ලෙස නිවැරදිව ලොග් වී සිටින්නේ නම් පමණක්, දත්ත පූරණය කරන්න.
            loadPlans(); 
        });
        
        // ----------------------------------------------------
        // B. Logout Functionality
        // ----------------------------------------------------
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await auth.signOut();
            window.location.href = ADMIN_LOGIN_PAGE;
        });


        // ----------------------------------------------------
        // 1. Firebase වෙතින් සැලසුම් දත්ත ලබාගෙන UI වෙත පූරණය කිරීම
        // ----------------------------------------------------
        async function loadPlans() {
            const container = document.getElementById('plans-container');
            container.innerHTML = ''; 

            try {
                // Security Rules වලට අනුව, Adminට පමණක් මෙය කියවීමට හැකි විය යුතුය.
                const plansSnapshot = await db.collection("plans").get();
                const plansData = {};
                plansSnapshot.forEach(doc => {
                    plansData[doc.id] = doc.data();
                });
                
                planIds.forEach(id => {
                    const plan = plansData[id] || {};

                    const html = `
                        <div class="plan-section">
                            <h2>${id.toUpperCase()} PLAN</h2>
                            <div class="input-group">
                                <label for="${id}-hashRate">Hash Rate (MH/s):</label>
                                <input type="number" id="${id}-hashRate" value="${plan.hashRate || 0.00}" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="${id}-price">Price ($):</label>
                                <input type="number" id="${id}-price" value="${plan.price || 0.00}" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="${id}-durationDays">Duration (Days):</label>
                                <input type="number" id="${id}-durationDays" value="${plan.durationDays || 0}" step="1">
                            </div>
                            <div class="input-group">
                                <label for="${id}-fullEarningXRP">Full Earning (XRP):</label>
                                <input type="number" id="${id}-fullEarningXRP" value="${plan.fullEarningXRP || 0.00}" step="0.01">
                            </div>
                            <button class="save-btn" onclick="savePlan('${id}')">Save ${id.toUpperCase()}</button>
                            <div id="${id}-message" class="message" style="display: none;"></div>
                        </div>
                    `;
                    container.innerHTML += html;
                });

            } catch (error) {
                console.error("Error loading plans:", error);
                // "Missing or insufficient permissions" දෝෂය මෙහිදී අල්ලා ගනී.
                container.innerHTML = `<div class="error">Error loading plans: Missing or insufficient permissions. (Code Error: ${error.message})</div>`;
            }
        }

        // ----------------------------------------------------
        // 2. වෙනස් කළ සැලසුම් දත්ත Firebase වෙත යැවීම
        // ----------------------------------------------------
        async function savePlan(planId) {
            const messageElement = document.getElementById(`${planId}-message`);
            messageElement.style.display = 'none';

            const hashRate = parseFloat(document.getElementById(`${planId}-hashRate`).value);
            const price = parseFloat(document.getElementById(`${planId}-price`).value);
            const durationDays = parseInt(document.getElementById(`${planId}-durationDays`).value);
            const fullEarningXRP = parseFloat(document.getElementById(`${planId}-fullEarningXRP`).value);

            if (isNaN(hashRate) || isNaN(price) || isNaN(durationDays) || isNaN(fullEarningXRP)) {
                messageElement.className = 'message error';
                messageElement.textContent = 'Please enter valid numbers for all fields.';
                messageElement.style.display = 'block';
                return;
            }

            try {
                // Security Rules වලට අනුව, Adminට පමණක් මෙය ලිවීමට (set) හැකි විය යුතුය.
                await db.collection("plans").doc(planId).set({
                    hashRate: hashRate,
                    price: price,
                    durationDays: durationDays,
                    fullEarningXRP: fullEarningXRP
                });

                messageElement.className = 'message success';
                messageElement.textContent = `${planId.toUpperCase()} Plan saved successfully!`;
                messageElement.style.display = 'block';
                
                setTimeout(() => { messageElement.style.display = 'none'; }, 3000);

            } catch (error) {
                console.error("Error saving plan:", error);
                messageElement.className = 'message error';
                messageElement.textContent = `Error saving: ${error.message}`;
                messageElement.style.display = 'block';
            }
        }
        
        // ⚠️ window.onload = loadPlans; ඉවත් කර ඇත. 
        // Auth Guard එක තුළින් loadPlans කැඳවනු ලැබේ.
    </script>
</body>
</html>
